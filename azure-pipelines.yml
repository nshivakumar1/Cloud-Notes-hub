# Azure DevOps Pipeline for Cloud Notes Hub 2.0
# This pipeline builds, tests, and deploys the Next.js app to Azure Static Web Apps

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md
      - docs/*

pool:
  name: 'Default'  # Self-hosted agent pool

variables:
  - group: cloud-notes-hub-secrets # Variable group containing Key Vault secrets
  - name: nodeVersion
    value: '20.x'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'
  # Azure resource names from Terraform
  - name: keyVaultName
    value: 'cloud-notes-hubprodkv'
  - name: storageAccountName
    value: 'cloudnoteshubprodst'
  # Service connection name - UPDATE THIS with your actual service connection name
  - name: azureSubscription
    value: 'Azure subscription 1'  # Change this to match your service connection name

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Next.js Application'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Npm@1
            displayName: 'Install Dependencies'
            inputs:
              command: 'install'
              workingDir: $(workingDirectory)

          - task: AzureKeyVault@2
            displayName: 'Get Secrets from Key Vault'
            inputs:
              azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
              KeyVaultName: 'cloud-notes-hubprodkv'
              SecretsFilter: 'supabase-url,supabase-anon-key'
              RunAsPreJob: false

          - script: |
              echo "NEXT_PUBLIC_SUPABASE_URL=$(supabase-url)" >> .env.production
              echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$(supabase-anon-key)" >> .env.production
            displayName: 'Create Production Environment File'
            workingDirectory: $(workingDirectory)

          - task: Npm@1
            displayName: 'Lint Code'
            inputs:
              command: 'custom'
              customCommand: 'run lint'
              workingDir: $(workingDirectory)

          - task: Npm@1
            displayName: 'Run Type Check'
            inputs:
              command: 'custom'
              customCommand: 'run build'
              workingDir: $(workingDirectory)

          # Create artifact staging directory with only necessary files
          - script: |
              mkdir -p $(Build.ArtifactStagingDirectory)/app
              # Copy only necessary files, excluding node_modules
              rsync -av --exclude='node_modules' \
                       --exclude='.git' \
                       --exclude='.next/cache' \
                       --exclude='coverage' \
                       --exclude='.env*' \
                       $(workingDirectory)/ $(Build.ArtifactStagingDirectory)/app/
            displayName: 'Prepare Artifact Files'
            workingDirectory: $(workingDirectory)

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Build Artifacts'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/app'
              artifact: 'drop'
              publishLocation: 'pipeline'
              parallel: true
              parallelCount: 8

  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployStaticWebApp
        displayName: 'Deploy to Azure Static Web Apps'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Build Artifacts'
                  inputs:
                    buildType: 'current'
                    artifactName: 'drop'
                    targetPath: '$(System.ArtifactsDirectory)/drop'

                - task: AzureStaticWebApp@0
                  displayName: 'Deploy to Static Web App'
                  inputs:
                    app_location: '$(System.ArtifactsDirectory)/drop'
                    skip_app_build: true
                    azure_static_web_apps_api_token: '$(staticWebAppApiToken)'
                  env:
                    NEXT_PUBLIC_SUPABASE_URL: $(supabase-url)
                    NEXT_PUBLIC_SUPABASE_ANON_KEY: $(supabase-anon-key)

  - stage: LogDeployment
    displayName: 'Log Deployment'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: LogJob
        displayName: 'Upload Deployment Logs'
        steps:
          - task: AzureCLI@2
            displayName: 'Upload logs to Azure Storage'
            inputs:
              azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Create log file
                LOG_FILE="deployment-$(Build.BuildId)-$(date +%Y%m%d-%H%M%S).log"
                echo "Build ID: $(Build.BuildId)" > $LOG_FILE
                echo "Build Number: $(Build.BuildNumber)" >> $LOG_FILE
                echo "Source Branch: $(Build.SourceBranchName)" >> $LOG_FILE
                echo "Commit: $(Build.SourceVersion)" >> $LOG_FILE
                echo "Timestamp: $(date)" >> $LOG_FILE
                echo "Status: Success" >> $LOG_FILE

                # Upload to Azure Storage
                az storage blob upload \
                  --account-name cloudnoteshubprodst \
                  --container-name logs \
                  --name $LOG_FILE \
                  --file $LOG_FILE \
                  --auth-mode key
