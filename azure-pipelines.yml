# Azure DevOps Pipeline for Cloud Notes Hub 2.0
# This pipeline builds, tests, and deploys the Next.js app to Azure Static Web Apps

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md
      - docs/*

pool:
  name: 'Default'  # Self-hosted agent pool

variables:
  - group: cloud-notes-hub-secrets # Variable group containing Key Vault secrets
  - name: nodeVersion
    value: '20.x'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'
  # Azure resource names from Terraform
  - name: keyVaultName
    value: 'cloud-notes-hubprodkv'
  - name: storageAccountName
    value: 'cloudnoteshubprodst'
  # Service connection name - UPDATE THIS with your actual service connection name
  - name: azureSubscription
    value: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'  # Change this to match your service connection name

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Next.js Application'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Npm@1
            displayName: 'Install Dependencies'
            inputs:
              command: 'install'
              workingDir: $(workingDirectory)

          - task: AzureKeyVault@2
            displayName: 'Get Secrets from Key Vault'
            inputs:
              azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
              KeyVaultName: 'cloud-notes-hubprodkv'
              SecretsFilter: 'supabase-url,supabase-anon-key'
              RunAsPreJob: false

          - script: |
              echo "NEXT_PUBLIC_SUPABASE_URL=$(supabase-url)" >> .env.production
              echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$(supabase-anon-key)" >> .env.production
            displayName: 'Create Production Environment File'
            workingDirectory: $(workingDirectory)

          - task: Npm@1
            displayName: 'Lint Code'
            inputs:
              command: 'custom'
              customCommand: 'run lint'
              workingDir: $(workingDirectory)

          - task: Npm@1
            displayName: 'Run Type Check'
            inputs:
              command: 'custom'
              customCommand: 'run build'
              workingDir: $(workingDirectory)

          # Create artifact staging directory with only necessary files
          - script: |
              mkdir -p $(Build.ArtifactStagingDirectory)/app
              # Copy only necessary files, excluding node_modules
              rsync -av --exclude='node_modules' \
                       --exclude='.git' \
                       --exclude='.next/cache' \
                       --exclude='coverage' \
                       --exclude='.env*' \
                       $(workingDirectory)/ $(Build.ArtifactStagingDirectory)/app/
            displayName: 'Prepare Artifact Files'
            workingDirectory: $(workingDirectory)

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Build Artifacts'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/app'
              artifact: 'drop'
              publishLocation: 'pipeline'
              parallel: true
              parallelCount: 8

  - stage: DockerBuildPush
    displayName: 'Build and Push Docker Image to ACR'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: BuildPushDockerImage
        displayName: 'Build and Push to Azure Container Registry'
        steps:
          - task: AzureKeyVault@2
            displayName: 'Get Secrets from Key Vault'
            inputs:
              azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
              KeyVaultName: 'cloud-notes-hubprodkv'
              SecretsFilter: 'supabase-url,supabase-anon-key'
              RunAsPreJob: false

          - task: AzureCLI@2
            displayName: 'Build and Push Docker Image to ACR'
            inputs:
              azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Login to ACR
                ACR_NAME="cloudnoteshubprodacr"
                ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)
                echo $ACR_PASSWORD | docker login $ACR_NAME.azurecr.io -u $ACR_NAME --password-stdin

                # Build the image with build arguments
                docker build \
                  --build-arg NEXT_PUBLIC_SUPABASE_URL='$(supabase-url)' \
                  --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY='$(supabase-anon-key)' \
                  -t $ACR_NAME.azurecr.io/cloud-notes-hub:$(Build.BuildId) \
                  -t $ACR_NAME.azurecr.io/cloud-notes-hub:latest \
                  -f $(workingDirectory)/Dockerfile \
                  $(workingDirectory)

                # Push both tags
                docker push $ACR_NAME.azurecr.io/cloud-notes-hub:$(Build.BuildId)
                docker push $ACR_NAME.azurecr.io/cloud-notes-hub:latest

                echo "Successfully built and pushed Docker images"

  - stage: Deploy
    displayName: 'Deploy to Azure Container Instances'
    dependsOn: DockerBuildPush
    condition: succeeded()
    jobs:
      - deployment: DeployContainerInstances
        displayName: 'Deploy to Azure Container Instances'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureKeyVault@2
                  displayName: 'Get Secrets from Key Vault'
                  inputs:
                    azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
                    KeyVaultName: 'cloud-notes-hubprodkv'
                    SecretsFilter: 'supabase-url,supabase-anon-key,app-insights-connection-string'
                    RunAsPreJob: false

                - task: AzureCLI@2
                  displayName: 'Deploy Main App Container Instance'
                  inputs:
                    azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Check if container group exists
                      if az container show --resource-group cloud-notes-hub-prod-rg --name cloud-notes-hub-prod-app &>/dev/null; then
                        echo "Deleting existing container group..."
                        az container delete --resource-group cloud-notes-hub-prod-rg --name cloud-notes-hub-prod-app --yes
                        echo "Waiting for deletion to complete..."
                        sleep 30
                      fi

                      echo "Creating new container instance..."
                      az container create \
                        --resource-group cloud-notes-hub-prod-rg \
                        --name cloud-notes-hub-prod-app \
                        --image cloudnoteshubprodacr.azurecr.io/cloud-notes-hub:latest \
                        --registry-login-server cloudnoteshubprodacr.azurecr.io \
                        --registry-username cloudnoteshubprodacr \
                        --registry-password $(az acr credential show --name cloudnoteshubprodacr --query "passwords[0].value" -o tsv) \
                        --dns-name-label cloudnoteshubprodapp \
                        --ports 3000 \
                        --cpu 1 \
                        --memory 1.5 \
                        --environment-variables \
                          NEXT_PUBLIC_SUPABASE_URL='$(supabase-url)' \
                          NEXT_PUBLIC_SUPABASE_ANON_KEY='$(supabase-anon-key)' \
                          APPLICATIONINSIGHTS_CONNECTION_STRING='$(app-insights-connection-string)' \
                          NODE_ENV='production' \
                        --restart-policy Always

                      echo "Container instance created successfully!"
                      echo "App URL: http://cloudnoteshubprodapp.eastus.azurecontainer.io:3000"

                - task: AzureCLI@2
                  displayName: 'Deploy Ansible Semaphore Container Instance'
                  inputs:
                    azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Check if container group exists
                      if az container show --resource-group cloud-notes-hub-prod-rg --name cloud-notes-hub-prod-semaphore &>/dev/null; then
                        echo "Semaphore container already exists, skipping..."
                      else
                        echo "Creating Semaphore container instance..."
                        az container create \
                          --resource-group cloud-notes-hub-prod-rg \
                          --name cloud-notes-hub-prod-semaphore \
                          --image semaphoreui/semaphore:latest \
                          --dns-name-label cloudnoteshubprodsemaphore \
                          --ports 3000 \
                          --cpu 0.5 \
                          --memory 1 \
                          --environment-variables \
                            SEMAPHORE_DB_DIALECT='bolt' \
                            SEMAPHORE_ADMIN='admin' \
                            SEMAPHORE_ADMIN_PASSWORD='changeme' \
                            SEMAPHORE_ADMIN_NAME='Administrator' \
                            SEMAPHORE_ADMIN_EMAIL='codecloudevops@outlook.com' \
                          --restart-policy Always

                        echo "Semaphore URL: http://cloudnoteshubprodsemaphore.eastus.azurecontainer.io:3000"
                      fi

  - stage: LogDeployment
    displayName: 'Log Deployment'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: LogJob
        displayName: 'Upload Deployment Logs'
        steps:
          - task: AzureCLI@2
            displayName: 'Upload logs to Azure Storage'
            inputs:
              azureSubscription: 'Azure subscription 1 (95c7aa64-5227-422a-afbd-e8eb5cb30122)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Create log file
                LOG_FILE="deployment-$(Build.BuildId)-$(date +%Y%m%d-%H%M%S).log"
                echo "Build ID: $(Build.BuildId)" > $LOG_FILE
                echo "Build Number: $(Build.BuildNumber)" >> $LOG_FILE
                echo "Source Branch: $(Build.SourceBranchName)" >> $LOG_FILE
                echo "Commit: $(Build.SourceVersion)" >> $LOG_FILE
                echo "Timestamp: $(date)" >> $LOG_FILE
                echo "Status: Success" >> $LOG_FILE

                # Upload to Azure Storage
                az storage blob upload \
                  --account-name cloudnoteshubprodst \
                  --container-name logs \
                  --name $LOG_FILE \
                  --file $LOG_FILE \
                  --auth-mode key
